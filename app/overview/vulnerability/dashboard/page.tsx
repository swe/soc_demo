'use client'
import { formatDate, formatDateTime } from '@/lib/utils'

import { useEffect, useState } from 'react'
import { usePageTitle } from '@/app/page-title-context'
import Link from 'next/link'
import dynamic from 'next/dynamic'
import type { ChartData } from 'chart.js'

// Dynamically import PieChart to avoid SSR issues
const PieChart = dynamic(() => import('@/components/charts/pie-chart').then(mod => ({ default: mod.default })), { 
  ssr: false,
  loading: () => (
    <div className="w-full h-full flex items-center justify-center">
      <div className="hig-caption">Loading chart...</div>
    </div>
  )
})

interface Vulnerability {
  id: string
  cve: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  cvssScore: number
  title: string
  affectedAssets: number
  status: 'open' | 'patching' | 'mitigated' | 'closed'
  discoveredAt: string
  ageInDays: number
  description?: string
  cwe?: string
  attackVector?: string
  exploitAvailable?: boolean
  remediation?: string
  affectedComponents?: string[]
}

export default function VulnerabilityDashboardPage() {
  const { setPageTitle } = usePageTitle()
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null)
  const [currentPage, setCurrentPage] = useState(1)
  const itemsPerPage = 10

  useEffect(() => {
    setPageTitle('Vulnerability Dashboard')
  }, [setPageTitle])

  const vulnerabilities: Vulnerability[] = [
    {
      id: 'VUL-001',
      cve: 'CVE-2024-1234',
      severity: 'critical',
      cvssScore: 9.8,
      title: 'Remote Code Execution in Apache Struts',
      affectedAssets: 23,
      status: 'patching',
      discoveredAt: '2024-03-28',
      ageInDays: 3,
      description: 'A critical vulnerability in Apache Struts framework allows remote attackers to execute arbitrary code through crafted OGNL expressions. This vulnerability affects Struts 2.x versions prior to 2.5.30.',
      cwe: 'CWE-94: Code Injection',
      attackVector: 'Network',
      exploitAvailable: true,
      remediation: 'Upgrade to Apache Struts 2.5.30 or later. Apply security patches immediately. Restrict network access to affected systems.',
      affectedComponents: ['Apache Struts 2.3.x', 'Apache Struts 2.5.x']
    },
    {
      id: 'VUL-002',
      cve: 'CVE-2024-5678',
      severity: 'high',
      cvssScore: 8.1,
      title: 'SQL Injection in Web Application',
      affectedAssets: 12,
      status: 'open',
      discoveredAt: '2024-03-25',
      ageInDays: 6,
      description: 'The web application fails to properly sanitize user input in database queries, allowing attackers to inject malicious SQL commands and potentially access or modify sensitive data.',
      cwe: 'CWE-89: SQL Injection',
      attackVector: 'Network',
      exploitAvailable: false,
      remediation: 'Implement parameterized queries and input validation. Use prepared statements for all database operations. Review and update authentication mechanisms.',
      affectedComponents: ['Web Application API', 'Database Layer']
    },
    {
      id: 'VUL-003',
      cve: 'CVE-2024-9012',
      severity: 'critical',
      cvssScore: 9.1,
      title: 'Authentication Bypass in Enterprise Software',
      affectedAssets: 45,
      status: 'mitigated',
      discoveredAt: '2024-03-20',
      ageInDays: 11,
      description: 'A flaw in the authentication mechanism allows unauthenticated users to bypass security controls and gain unauthorized access to the system by manipulating session tokens.',
      cwe: 'CWE-287: Improper Authentication',
      attackVector: 'Network',
      exploitAvailable: true,
      remediation: 'Update authentication module to latest version. Implement multi-factor authentication. Review session management implementation.',
      affectedComponents: ['Authentication Service', 'Session Manager']
    },
    {
      id: 'VUL-004',
      cve: 'CVE-2024-3456',
      severity: 'medium',
      cvssScore: 6.5,
      title: 'Cross-Site Scripting Vulnerability',
      affectedAssets: 8,
      status: 'closed',
      discoveredAt: '2024-03-15',
      ageInDays: 16,
      description: 'The application does not properly sanitize user input before rendering it in web pages, allowing attackers to inject malicious scripts that execute in the context of other users\' browsers.',
      cwe: 'CWE-79: Cross-site Scripting',
      attackVector: 'Network',
      exploitAvailable: false,
      remediation: 'Implement proper input validation and output encoding. Use Content Security Policy (CSP) headers. Sanitize all user-generated content.',
      affectedComponents: ['Web Frontend', 'User Input Handler']
    },
    {
      id: 'VUL-005',
      cve: 'CVE-2024-7890',
      severity: 'high',
      cvssScore: 7.8,
      title: 'Privilege Escalation in Linux Kernel',
      affectedAssets: 67,
      status: 'patching',
      discoveredAt: '2024-03-22',
      ageInDays: 9,
      description: 'A flaw in the Linux kernel\'s permission handling allows local users to escalate privileges to root by exploiting a race condition in the permission checking mechanism.',
      cwe: 'CWE-269: Improper Privilege Management',
      attackVector: 'Local',
      exploitAvailable: true,
      remediation: 'Update Linux kernel to version 5.15.0 or later. Apply security patches. Restrict local access to affected systems.',
      affectedComponents: ['Linux Kernel 5.10.x', 'Linux Kernel 5.12.x']
    },
    {
      id: 'VUL-006',
      cve: 'CVE-2024-2341',
      severity: 'critical',
      cvssScore: 9.5,
      title: 'Remote Code Execution in Log4j',
      affectedAssets: 34,
      status: 'open',
      discoveredAt: '2024-03-27',
      ageInDays: 4
    },
    {
      id: 'VUL-007',
      cve: 'CVE-2024-5679',
      severity: 'high',
      cvssScore: 8.3,
      title: 'Path Traversal in File System',
      affectedAssets: 19,
      status: 'patching',
      discoveredAt: '2024-03-24',
      ageInDays: 7
    },
    {
      id: 'VUL-008',
      cve: 'CVE-2024-8901',
      severity: 'medium',
      cvssScore: 6.8,
      title: 'Information Disclosure in API',
      affectedAssets: 15,
      status: 'open',
      discoveredAt: '2024-03-18',
      ageInDays: 13
    },
    {
      id: 'VUL-009',
      cve: 'CVE-2024-4567',
      severity: 'low',
      cvssScore: 4.2,
      title: 'Weak Encryption in Database',
      affectedAssets: 5,
      status: 'mitigated',
      discoveredAt: '2024-03-10',
      ageInDays: 21
    },
    {
      id: 'VUL-010',
      cve: 'CVE-2024-1123',
      severity: 'critical',
      cvssScore: 9.3,
      title: 'Command Injection in Web Shell',
      affectedAssets: 28,
      status: 'open',
      discoveredAt: '2024-03-26',
      ageInDays: 5
    },
    {
      id: 'VUL-011',
      cve: 'CVE-2024-7891',
      severity: 'high',
      cvssScore: 7.9,
      title: 'Buffer Overflow in Network Service',
      affectedAssets: 42,
      status: 'patching',
      discoveredAt: '2024-03-21',
      ageInDays: 10
    },
    {
      id: 'VUL-012',
      cve: 'CVE-2024-3457',
      severity: 'medium',
      cvssScore: 6.2,
      title: 'Session Fixation Vulnerability',
      affectedAssets: 11,
      status: 'closed',
      discoveredAt: '2024-03-12',
      ageInDays: 19
    },
    {
      id: 'VUL-013',
      cve: 'CVE-2024-9013',
      severity: 'critical',
      cvssScore: 9.6,
      title: 'Zero-Day Exploit in Browser',
      affectedAssets: 56,
      status: 'open',
      discoveredAt: '2024-03-29',
      ageInDays: 2
    },
    {
      id: 'VUL-014',
      cve: 'CVE-2024-2342',
      severity: 'high',
      cvssScore: 8.0,
      title: 'XML External Entity Injection',
      affectedAssets: 24,
      status: 'mitigated',
      discoveredAt: '2024-03-19',
      ageInDays: 12
    },
    {
      id: 'VUL-015',
      cve: 'CVE-2024-5670',
      severity: 'medium',
      cvssScore: 5.8,
      title: 'Insecure Direct Object Reference',
      affectedAssets: 9,
      status: 'patching',
      discoveredAt: '2024-03-16',
      ageInDays: 15
    },
    {
      id: 'VUL-016',
      cve: 'CVE-2024-8902',
      severity: 'low',
      cvssScore: 3.5,
      title: 'Missing Security Headers',
      affectedAssets: 3,
      status: 'closed',
      discoveredAt: '2024-03-08',
      ageInDays: 23
    },
    {
      id: 'VUL-017',
      cve: 'CVE-2024-4568',
      severity: 'critical',
      cvssScore: 9.4,
      title: 'Remote Code Execution via Deserialization',
      affectedAssets: 38,
      status: 'open',
      discoveredAt: '2024-03-23',
      ageInDays: 8
    },
    {
      id: 'VUL-018',
      cve: 'CVE-2024-1124',
      severity: 'high',
      cvssScore: 7.6,
      title: 'Server-Side Request Forgery',
      affectedAssets: 31,
      status: 'patching',
      discoveredAt: '2024-03-17',
      ageInDays: 14
    },
    {
      id: 'VUL-019',
      cve: 'CVE-2024-7892',
      severity: 'medium',
      cvssScore: 6.4,
      title: 'Open Redirect Vulnerability',
      affectedAssets: 17,
      status: 'mitigated',
      discoveredAt: '2024-03-14',
      ageInDays: 17
    },
    {
      id: 'VUL-020',
      cve: 'CVE-2024-3458',
      severity: 'high',
      cvssScore: 8.2,
      title: 'Race Condition in File Operations',
      affectedAssets: 26,
      status: 'open',
      discoveredAt: '2024-03-11',
      ageInDays: 20
    },
    {
      id: 'VUL-021',
      cve: 'CVE-2024-9014',
      severity: 'critical',
      cvssScore: 9.7,
      title: 'Memory Corruption in Image Parser',
      affectedAssets: 52,
      status: 'patching',
      discoveredAt: '2024-03-13',
      ageInDays: 18
    },
    {
      id: 'VUL-022',
      cve: 'CVE-2024-2343',
      severity: 'medium',
      cvssScore: 5.9,
      title: 'Insufficient Session Expiration',
      affectedAssets: 14,
      status: 'closed',
      discoveredAt: '2024-03-09',
      ageInDays: 22
    },
    {
      id: 'VUL-023',
      cve: 'CVE-2024-5671',
      severity: 'low',
      cvssScore: 4.1,
      title: 'Weak Password Policy',
      affectedAssets: 6,
      status: 'mitigated',
      discoveredAt: '2024-03-07',
      ageInDays: 24
    }
  ]

  // Pagination calculations
  const totalPages = Math.ceil(vulnerabilities.length / itemsPerPage)
  const startIndex = (currentPage - 1) * itemsPerPage
  const endIndex = startIndex + itemsPerPage
  const currentVulnerabilities = vulnerabilities.slice(startIndex, endIndex)

  const handlePageChange = (page: number) => {
    setCurrentPage(page)
    setSelectedVuln(null) // Close expanded details when changing page
  }

  // System colors for severity (Apple HIG)
  const getSeverityColor = (severity: string): string => {
    const colors: Record<string, string> = {
      'critical': '#FF3B30',  // System red
      'high': '#FF9500',      // System orange
      'medium': '#FFCC00',    // System yellow
      'low': '#007AFF'        // System blue
    }
    return colors[severity] || '#8E8E93'
  }

  // System colors for status
  const getStatusColor = (status: string): string => {
    const colors: Record<string, string> = {
      'open': '#FF3B30',      // System red
      'patching': '#FF9500',   // System orange
      'mitigated': '#007AFF',  // System blue
      'closed': '#34C759'      // System green
    }
    return colors[status] || '#8E8E93'
  }

  const stats = {
    total: vulnerabilities.length,
    critical: vulnerabilities.filter(v => v.severity === 'critical').length,
    high: vulnerabilities.filter(v => v.severity === 'high').length,
    medium: vulnerabilities.filter(v => v.severity === 'medium').length,
    low: vulnerabilities.filter(v => v.severity === 'low').length,
    open: vulnerabilities.filter(v => v.status === 'open').length,
    patching: vulnerabilities.filter(v => v.status === 'patching').length,
    mitigated: vulnerabilities.filter(v => v.status === 'mitigated').length,
    closed: vulnerabilities.filter(v => v.status === 'closed').length,
    affectedAssets: vulnerabilities.reduce((sum, v) => sum + v.affectedAssets, 0)
  }

  // Prepare chart data for Vulnerability Distribution
  const chartData: ChartData<'pie'> = {
    labels: ['Critical', 'High', 'Medium', 'Low'],
    datasets: [
      {
        label: 'Vulnerabilities',
        data: [stats.critical, stats.high, stats.medium, stats.low],
        backgroundColor: ['#FF3B30', '#FF9500', '#FFCC00', '#007AFF'],
        borderWidth: 0,
      },
    ],
  }

  // Only render chart if we have data
  const hasChartData = stats.critical > 0 || stats.high > 0 || stats.medium > 0 || stats.low > 0

  return (
    <div className="py-8 w-full max-w-7xl mx-auto">
      {/* Page Header */}
      <div className="mb-6 px-4 hig-fade-in">
        <div className="flex items-center justify-between mb-2">
          <h1 className="hig-title-large text-gray-900 dark:text-gray-100">Vulnerability Dashboard</h1>
          <Link href="/overview/vulnerability/recommendations" className="hig-caption hig-link-hover">
            View Recommendations â†’
          </Link>
        </div>
        <p className="hig-body text-gray-600 dark:text-gray-400">Monitor and manage security vulnerabilities across your infrastructure</p>
      </div>

      {/* Main Layout - Split Screen: Table + Sidebar */}
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 px-4">
        {/* Main Content - Vulnerabilities Table */}
        <div className="lg:col-span-8">
          <div className="hig-card">
            <div className="flex items-center justify-between mb-6 pb-4 border-b border-gray-200 dark:border-gray-700/60">
              <h2 className="hig-headline text-gray-900 dark:text-gray-100">Vulnerabilities</h2>
              <div className="flex items-center gap-4">
                <span className="hig-caption text-gray-600 dark:text-gray-400">{stats.total} total</span>
              </div>
            </div>

            {/* Table-like List */}
            <div className="space-y-0">
              {currentVulnerabilities.map((vuln, idx) => {
                const severityColor = getSeverityColor(vuln.severity)
                const statusColor = getStatusColor(vuln.status)
                const isExpanded = selectedVuln?.id === vuln.id
                
                return (
                  <div key={vuln.id}>
                    <div 
                      className={`flex items-center gap-4 p-4 cursor-pointer ${
                        idx !== currentVulnerabilities.length - 1 ? 'border-b border-gray-200 dark:border-gray-700/60' : ''
                      } ${isExpanded ? 'bg-gray-50 dark:bg-[#334155]/30' : 'hover:bg-gray-50 dark:hover:bg-[#334155]/20'}`}
                      onClick={() => setSelectedVuln(isExpanded ? null : vuln)}
                    >
                      {/* Severity Indicator */}
                      <div 
                        className="w-1 h-12 rounded-full flex-shrink-0"
                        style={{ 
                          backgroundColor: severityColor,
                          boxShadow: `0 0 8px ${severityColor}40`
                        }}
                      />
                      
                      {/* CVE */}
                      <div className="w-32 flex-shrink-0">
                        <span className="hig-caption font-mono text-gray-600 dark:text-gray-400 hover:text-[#AF52DE]">
                          {vuln.cve}
                        </span>
                      </div>
                      
                      {/* Title */}
                      <div className="flex-1 min-w-0">
                        <h3 className="hig-body font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2" title={vuln.title}>
                          {vuln.title}
                        </h3>
                        <div className="flex items-center gap-2 flex-wrap">
                          <span 
                            className="hig-badge"
                            style={{
                              backgroundColor: `${severityColor}20`,
                              color: severityColor
                            }}
                          >
                            {vuln.severity.toUpperCase()}
                          </span>
                          <span 
                            className="hig-badge"
                            style={{
                              backgroundColor: `${statusColor}20`,
                              color: statusColor
                            }}
                          >
                            {vuln.status.toUpperCase()}
                          </span>
                        </div>
                      </div>
                      
                      {/* Metrics */}
                      <div className="flex items-center gap-6 flex-shrink-0">
                        <div className="text-right">
                          <div className="hig-caption text-gray-600 dark:text-gray-400">CVSS</div>
                          <div className="hig-body font-bold text-gray-900 dark:text-gray-100">{vuln.cvssScore}</div>
                        </div>
                        <div className="text-right">
                          <div className="hig-caption text-gray-600 dark:text-gray-400">Assets</div>
                          <div className="hig-body font-semibold text-gray-900 dark:text-gray-100">{vuln.affectedAssets}</div>
                        </div>
                        <div className="text-right w-20">
                          <div className="hig-caption text-gray-600 dark:text-gray-400">Age</div>
                          <div 
                            className="hig-body font-semibold"
                            style={{ 
                              color: vuln.ageInDays > 7 ? '#FF3B30' : undefined
                            }}
                          >
                            {vuln.ageInDays}d
                          </div>
                        </div>
                        <button className="text-gray-400 hover:text-[#AF52DE] flex-shrink-0">
                          <svg 
                            className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                            fill="none" 
                            viewBox="0 0 24 24" 
                            stroke="currentColor"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="px-4 pb-4 bg-gray-50 dark:bg-[#334155]/30 border-b border-gray-200 dark:border-gray-700/60">
                        <div className="pt-4 space-y-4">
                          {/* Description */}
                          {vuln.description && (
                            <div>
                              <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2 font-semibold">Description</div>
                              <div className="hig-body text-gray-700 dark:text-gray-300 leading-relaxed">
                                {vuln.description}
                              </div>
                            </div>
                          )}

                          {/* Technical Details */}
                          <div className="grid grid-cols-2 gap-4">
                            {vuln.cwe && (
                              <div>
                                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">CWE</div>
                                <div className="hig-body font-semibold text-gray-900 dark:text-gray-100">{vuln.cwe}</div>
                              </div>
                            )}
                            {vuln.attackVector && (
                              <div>
                                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Attack Vector</div>
                                <div className="hig-body font-semibold text-gray-900 dark:text-gray-100">{vuln.attackVector}</div>
                              </div>
                            )}
                            {vuln.exploitAvailable !== undefined && (
                              <div>
                                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Exploit Available</div>
                                <div className="flex items-center gap-2">
                                  <div 
                                    className={`w-2 h-2 rounded-full ${vuln.exploitAvailable ? 'bg-[#FF3B30]' : 'bg-[#34C759]'}`}
                                  ></div>
                                  <span className="hig-body font-semibold text-gray-900 dark:text-gray-100">
                                    {vuln.exploitAvailable ? 'Yes' : 'No'}
                                  </span>
                                </div>
                              </div>
                            )}
                            <div>
                              <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Discovered</div>
                              <div className="hig-body font-semibold text-gray-900 dark:text-gray-100">
                                {formatDate(vuln.discoveredAt)}
                              </div>
                            </div>
                          </div>

                          {/* Affected Components */}
                          {vuln.affectedComponents && vuln.affectedComponents.length > 0 && (
                            <div>
                              <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2 font-semibold">Affected Components</div>
                              <div className="flex flex-wrap gap-2">
                                {vuln.affectedComponents.map((component, idx) => (
                                  <span 
                                    key={idx}
                                    className="hig-badge bg-gray-200 dark:bg-[#334155] text-gray-700 dark:text-gray-300"
                                  >
                                    {component}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Remediation */}
                          {vuln.remediation && (
                            <div>
                              <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2 font-semibold">Remediation</div>
                              <div className="hig-body text-gray-700 dark:text-gray-300 leading-relaxed">
                                {vuln.remediation}
                              </div>
                            </div>
                          )}

                          {/* Action Buttons */}
                          <div className="flex gap-3 pt-2">
                            <button className="hig-button hig-button-primary flex-1">
                              Assign to Team
                            </button>
                            <button className="hig-button hig-button-secondary flex-1">
                              Start Remediation
                            </button>
                            <button className="hig-button hig-button-secondary flex-1">
                              View CVE Details
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )
              })}
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700/60">
                <div className="flex items-center justify-between">
                  <div className="hig-caption text-gray-600 dark:text-gray-400">
                    Showing <span className="font-semibold text-gray-900 dark:text-gray-100">{startIndex + 1}</span> to{' '}
                    <span className="font-semibold text-gray-900 dark:text-gray-100">{Math.min(endIndex, vulnerabilities.length)}</span> of{' '}
                    <span className="font-semibold text-gray-900 dark:text-gray-100">{vulnerabilities.length}</span> results
                  </div>
                  <nav className="flex items-center gap-2" role="navigation">
                    <button
                      className={`hig-button hig-button-secondary ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}`}
                      onClick={() => handlePageChange(currentPage - 1)}
                      disabled={currentPage === 1}
                    >
                      Previous
                    </button>
                    <div className="flex items-center gap-1">
                      {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                        let pageNum
                        if (totalPages <= 5) {
                          pageNum = i + 1
                        } else if (currentPage <= 3) {
                          pageNum = i + 1
                        } else if (currentPage >= totalPages - 2) {
                          pageNum = totalPages - 4 + i
                        } else {
                          pageNum = currentPage - 2 + i
                        }
                        return (
                          <button
                            key={pageNum}
                            className={`hig-button ${currentPage === pageNum ? 'hig-button-primary' : 'hig-button-secondary'}`}
                            onClick={() => handlePageChange(pageNum)}
                          >
                            {pageNum}
                          </button>
                        )
                      })}
                    </div>
                    <button
                      className={`hig-button hig-button-secondary ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}`}
                      onClick={() => handlePageChange(currentPage + 1)}
                      disabled={currentPage === totalPages}
                    >
                      Next
                    </button>
                  </nav>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Sidebar - Analytics */}
        <div className="lg:col-span-4 space-y-6">
          {/* Combined Overview & Status */}
          <div className="hig-card">
            <h2 className="hig-headline text-gray-900 dark:text-gray-100 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700/60">Overview & Status</h2>
            
            {/* Key Metrics Grid */}
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div className="bg-gray-50 dark:bg-[#334155]/30 rounded-lg p-4 text-center">
                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Total</div>
                <div className="hig-metric-value text-3xl text-gray-900 dark:text-gray-100">
                  {stats.total}
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-[#334155]/30 rounded-lg p-4 text-center">
                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Assets</div>
                <div className="hig-metric-value text-3xl text-gray-900 dark:text-gray-100">
                  {stats.affectedAssets}
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-[#334155]/30 rounded-lg p-4 text-center">
                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Critical</div>
                <div 
                  className="text-3xl font-bold"
                  style={{ 
                    color: '#FF3B30',
                    WebkitTextFillColor: '#FF3B30'
                  }}
                >
                  {stats.critical}
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-[#334155]/30 rounded-lg p-4 text-center">
                <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">High</div>
                <div 
                  className="text-3xl font-bold"
                  style={{ 
                    color: '#FF9500',
                    WebkitTextFillColor: '#FF9500'
                  }}
                >
                  {stats.high}
                </div>
              </div>
            </div>

            {/* Status Breakdown */}
            <div className="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700/60">
              {[
                { status: 'Open', count: stats.open, color: '#FF3B30' },
                { status: 'Patching', count: stats.patching, color: '#FF9500' },
                { status: 'Mitigated', count: stats.mitigated, color: '#007AFF' },
                { status: 'Closed', count: stats.closed, color: '#34C759' }
              ].map((item, idx) => (
                <div key={idx}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="hig-body text-gray-700 dark:text-gray-300">{item.status}</span>
                    <span className="hig-body font-semibold text-gray-900 dark:text-gray-100">{item.count}</span>
                  </div>
                  <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div 
                      className="h-2 rounded-full" 
                      style={{ 
                        width: `${(item.count / stats.total) * 100}%`,
                        backgroundColor: item.color
                      }}
                    ></div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Distribution Chart */}
          <div className="hig-card">
            <h2 className="hig-headline text-gray-900 dark:text-gray-100 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700/60">Distribution</h2>
            <div className="h-[240px]">
              {hasChartData ? (
                <PieChart data={chartData} width={300} height={240} />
              ) : (
                <div className="w-full h-full flex items-center justify-center">
                  <div className="hig-caption text-gray-500 dark:text-gray-400">No data</div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

