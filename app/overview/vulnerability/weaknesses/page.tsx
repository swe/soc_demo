'use client'
import { formatDate, formatDateTime } from '@/lib/utils'
import { useEffect, useState } from 'react'
import { usePageTitle } from '@/app/page-title-context'

interface Weakness {
  id: string
  cwe: string
  name: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  occurrences: number
  affectedComponents: string[]
  mitigationStrategy: string
  status: 'identified' | 'analyzing' | 'mitigating' | 'resolved'
  discoveredAt: string
}

export default function WeaknessesPage() {
  const { setPageTitle } = usePageTitle()
  const [selectedWeakness, setSelectedWeakness] = useState<Weakness | null>(null)

  useEffect(() => {
    setPageTitle('Weaknesses')
  }, [setPageTitle])

  const weaknesses: Weakness[] = [
    {
      id: 'CWE-001',
      cwe: 'CWE-89',
      name: 'SQL Injection',
      severity: 'critical',
      occurrences: 12,
      affectedComponents: ['Web Application', 'API Gateway', 'Admin Portal'],
      mitigationStrategy: 'Implement parameterized queries and input validation',
      status: 'mitigating',
      discoveredAt: '2024-03-15'
    },
    {
      id: 'CWE-002',
      cwe: 'CWE-79',
      name: 'Cross-site Scripting (XSS)',
      severity: 'high',
      occurrences: 8,
      affectedComponents: ['Web Application', 'User Dashboard'],
      mitigationStrategy: 'Implement output encoding and CSP headers',
      status: 'analyzing',
      discoveredAt: '2024-03-20'
    },
    {
      id: 'CWE-003',
      cwe: 'CWE-287',
      name: 'Improper Authentication',
      severity: 'critical',
      occurrences: 5,
      affectedComponents: ['Authentication Service', 'Mobile App'],
      mitigationStrategy: 'Implement MFA and strengthen authentication mechanisms',
      status: 'mitigating',
      discoveredAt: '2024-03-10'
    },
    {
      id: 'CWE-004',
      cwe: 'CWE-200',
      name: 'Information Exposure',
      severity: 'medium',
      occurrences: 15,
      affectedComponents: ['API Endpoints', 'Error Pages'],
      mitigationStrategy: 'Remove sensitive information from error messages',
      status: 'identified',
      discoveredAt: '2024-03-22'
    },
    {
      id: 'CWE-005',
      cwe: 'CWE-22',
      name: 'Path Traversal',
      severity: 'high',
      occurrences: 3,
      affectedComponents: ['File Upload Service'],
      mitigationStrategy: 'Implement proper file path validation',
      status: 'resolved',
      discoveredAt: '2024-02-28'
    }
  ]

  const getSeverityColor = (severity: string): string => {
    const colors: Record<string, string> = {
      critical: '#e11d48',  // System red
      high: '#ea580c',      // System orange
      medium: '#d97706',    // System yellow
      low: '#4f46e5'        // System blue
    }
    return colors[severity] || '#6b7280'
  }

  const getStatusColor = (status: string): string => {
    const colors: Record<string, string> = {
      identified: '#4f46e5',   // System purple
      analyzing: '#4f46e5',    // System blue
      mitigating: '#ea580c',    // System orange
      resolved: '#059669'      // System green
    }
    return colors[status] || '#6b7280'
  }

  const stats = {
    total: weaknesses.length,
    critical: weaknesses.filter(w => w.severity === 'critical').length,
    totalOccurrences: weaknesses.reduce((sum, w) => sum + w.occurrences, 0),
    resolved: weaknesses.filter(w => w.status === 'resolved').length
  }

  return (
    <div className="py-4 w-full max-w-7xl mx-auto">
      <div className="mb-6 px-4 hig-fade-in">
        <h1 className="hig-title-large text-gray-900 dark:text-gray-100 mb-2">Security Weaknesses (CWE)</h1>
        <p className="hig-body text-gray-600 dark:text-gray-400">Track Common Weakness Enumeration findings and mitigation efforts</p>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-3 px-4">
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Total Weaknesses</div>
          <div className="hig-metric-value text-4xl text-gray-900 dark:text-gray-100">{stats.total}</div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Critical Severity</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#e11d48', WebkitTextFillColor: '#e11d48' }}>
            {stats.critical}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Total Occurrences</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#ea580c', WebkitTextFillColor: '#ea580c' }}>
            {stats.totalOccurrences}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Resolved</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#059669', WebkitTextFillColor: '#059669' }}>
            {stats.resolved}
          </div>
        </div>
      </div>

      {/* Weaknesses List */}
      <div className="px-4">
        <div className="hig-card">
          <div className="flex items-center justify-between mb-3 pb-4 border-b border-gray-200 dark:border-gray-700/60">
            <h2 className="hig-headline text-gray-900 dark:text-gray-100">Identified Weaknesses</h2>
            <span className="hig-caption text-gray-600 dark:text-gray-400">{weaknesses.length} total</span>
          </div>

          <div className="space-y-0">
          {weaknesses.map((weakness, idx) => {
            const severityColor = getSeverityColor(weakness.severity)
            const statusColor = getStatusColor(weakness.status)
            
            return (
              <div key={weakness.id}>
                <div 
                  className={`flex items-center gap-4 p-4 cursor-pointer ${
                    idx !== weaknesses.length - 1 ? 'border-b border-gray-200 dark:border-gray-700/60' : ''
                  } hover:bg-gray-50 dark:hover:bg-gray-700/20`}
                  onClick={() => setSelectedWeakness(weakness)}
                >
                  {/* Severity Indicator */}
                  <div 
                    className="w-1 h-12 rounded-full flex-shrink-0"
                    style={{ 
                      backgroundColor: severityColor,
                      boxShadow: `0 0 8px ${severityColor}40`
                    }}
                  />
                  
                  {/* CWE ID */}
                  <div className="w-24 flex-shrink-0">
                    <span className="hig-caption font-mono text-gray-600 dark:text-gray-400">
                      {weakness.cwe}
                    </span>
                  </div>
                  
                  {/* Weakness Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="hig-body font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2" title={weakness.name}>
                      {weakness.name}
                    </h3>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${severityColor}20`,
                          color: severityColor
                        }}
                      >
                        {weakness.severity.toUpperCase()}
                      </span>
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${statusColor}20`,
                          color: statusColor
                        }}
                      >
                        {weakness.status.toUpperCase()}
                      </span>
                      <span className="hig-caption text-gray-600 dark:text-gray-400">{weakness.occurrences} occurrences</span>
                      <span className="hig-caption text-gray-400">•</span>
                      <span className="hig-caption text-gray-600 dark:text-gray-400">Discovered: {formatDate(weakness.discoveredAt)}</span>
                    </div>
                  </div>
                  
                  {/* View Details Link */}
                  <div className="flex-shrink-0">
                    <span className="hig-caption hig-link-hover">
                      View Details →
                    </span>
                  </div>
                </div>
              </div>
            )
          })}
          </div>
        </div>
      </div>

      {/* Weakness Detail Modal */}
      {selectedWeakness && (
        <div className="hig-modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="hig-modal p-0 max-w-4xl w-full flex flex-col max-h-[90vh]">
            {/* Fixed Header */}
            <div 
              className="sticky top-0 z-10 backdrop-blur-xl backdrop-saturate-150 bg-white/80 dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-700/60 p-6 pb-4"
              style={{
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                backdropFilter: 'blur(20px) saturate(180%)'
              }}
            >
              <div className="flex items-center justify-between mb-2">
                <h2 className="hig-headline text-gray-900 dark:text-gray-100">Weakness Details</h2>
                <button
                  onClick={() => setSelectedWeakness(null)}
                  className="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
                >
                  <span className="sr-only">Close</span>
                  <svg className="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                  </svg>
                </button>
              </div>
              {/* Severity Indicator Bar */}
              <div 
                className="h-1 rounded-full" 
                style={{ backgroundColor: getSeverityColor(selectedWeakness.severity) }}
              />
            </div>

            {/* Scrollable Content */}
            <div className="flex-1 overflow-y-auto px-6 py-6">
              <div className="space-y-4 pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <div>
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">CWE ID</div>
                  <div className="hig-body font-mono text-gray-900 dark:text-gray-100">{selectedWeakness.cwe}</div>
                </div>

                <div>
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Name</div>
                  <div className="hig-headline text-gray-900 dark:text-gray-100">{selectedWeakness.name}</div>
                </div>

                <div className="flex items-center gap-3">
                  <div>
                    <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Severity</div>
                    <span 
                      className="hig-badge"
                      style={{
                        backgroundColor: `${getSeverityColor(selectedWeakness.severity)}20`,
                        color: getSeverityColor(selectedWeakness.severity)
                      }}
                    >
                      {selectedWeakness.severity.toUpperCase()}
                    </span>
                  </div>
                  <div>
                    <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Status</div>
                    <span 
                      className="hig-badge"
                      style={{
                        backgroundColor: `${getStatusColor(selectedWeakness.status)}20`,
                        color: getStatusColor(selectedWeakness.status)
                      }}
                    >
                      {selectedWeakness.status.toUpperCase()}
                    </span>
                  </div>
                </div>
              </div>

              {/* Metric Cards */}
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Occurrences</div>
                  <div className="hig-metric-value text-3xl text-gray-900 dark:text-gray-100">
                    {selectedWeakness.occurrences}
                  </div>
                </div>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Discovered</div>
                  <div className="hig-body text-gray-900 dark:text-gray-100 font-medium">
                    {formatDate(selectedWeakness.discoveredAt)}
                  </div>
                </div>
              </div>

              {/* Affected Components */}
              <div className="pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <h3 className="hig-headline mb-4">Affected Components</h3>
                <div className="flex flex-wrap gap-2">
                  {selectedWeakness.affectedComponents.map((component, idx) => (
                    <span 
                      key={idx} 
                      className="hig-badge"
                      style={{
                        backgroundColor: 'rgba(107, 114, 128, 0.2)',
                        color: '#6b7280'
                      }}
                    >
                      {component}
                    </span>
                  ))}
                </div>
              </div>

              {/* Mitigation Strategy */}
              <div className="pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <h3 className="hig-headline mb-4">Mitigation Strategy</h3>
                <div className="hig-card bg-[#4f46e5]/10 dark:bg-[#4f46e5]/20 border border-[#4f46e5]/30 p-4">
                  <div className="hig-body text-gray-900 dark:text-gray-100">{selectedWeakness.mitigationStrategy}</div>
                </div>
              </div>
            </div>

            {/* Fixed Footer */}
            <div 
              className="sticky bottom-0 z-10 backdrop-blur-xl backdrop-saturate-150 bg-white/80 dark:bg-gray-900/80 border-t border-gray-200 dark:border-gray-700/60 p-6 pt-4"
              style={{
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                backdropFilter: 'blur(20px) saturate(180%)'
              }}
            >
              <div className="flex gap-3">
                <a 
                  href={`https://cwe.mitre.org/data/definitions/${selectedWeakness.cwe.replace('CWE-', '')}.html`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="hig-button hig-button-primary flex-1 text-center"
                >
                  View on MITRE CWE
                </a>
                <button className="hig-button hig-button-secondary flex-1" onClick={() => setSelectedWeakness(null)}>
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
