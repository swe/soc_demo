'use client'
import { formatDate, formatDateTime } from '@/lib/utils'
import { useEffect, useState } from 'react'
import { usePageTitle } from '@/app/page-title-context'

interface Recommendation {
  id: string
  title: string
  priority: 'critical' | 'high' | 'medium' | 'low'
  category: 'patching' | 'configuration' | 'access-control' | 'monitoring'
  affectedAssets: number
  estimatedEffort: string
  potentialRiskReduction: number
  status: 'pending' | 'in-progress' | 'completed' | 'dismissed'
  dueDate: string
}

export default function RecommendationsPage() {
  const { setPageTitle } = usePageTitle()
  const [filterPriority, setFilterPriority] = useState<string>('all')
  const [selectedRec, setSelectedRec] = useState<Recommendation | null>(null)

  useEffect(() => {
    setPageTitle('Recommendations')
  }, [setPageTitle])

  const recommendations: Recommendation[] = [
    {
      id: 'REC-001',
      title: 'Patch Critical Apache Struts Vulnerability',
      priority: 'critical',
      category: 'patching',
      affectedAssets: 23,
      estimatedEffort: '4 hours',
      potentialRiskReduction: 95,
      status: 'in-progress',
      dueDate: '2024-04-01'
    },
    {
      id: 'REC-002',
      title: 'Enable MFA for All Administrative Accounts',
      priority: 'high',
      category: 'access-control',
      affectedAssets: 45,
      estimatedEffort: '2 days',
      potentialRiskReduction: 87,
      status: 'pending',
      dueDate: '2024-04-05'
    },
    {
      id: 'REC-003',
      title: 'Update TLS Configuration to v1.3',
      priority: 'medium',
      category: 'configuration',
      affectedAssets: 67,
      estimatedEffort: '1 day',
      potentialRiskReduction: 65,
      status: 'pending',
      dueDate: '2024-04-10'
    },
    {
      id: 'REC-004',
      title: 'Implement EDR on All Endpoints',
      priority: 'high',
      category: 'monitoring',
      affectedAssets: 234,
      estimatedEffort: '1 week',
      potentialRiskReduction: 82,
      status: 'in-progress',
      dueDate: '2024-04-15'
    },
    {
      id: 'REC-005',
      title: 'Disable SMBv1 Protocol',
      priority: 'critical',
      category: 'configuration',
      affectedAssets: 89,
      estimatedEffort: '6 hours',
      potentialRiskReduction: 91,
      status: 'pending',
      dueDate: '2024-04-02'
    }
  ]

  const getPriorityColor = (priority: string): string => {
    const colors: Record<string, string> = {
      critical: '#e11d48',  // System red
      high: '#ea580c',      // System orange
      medium: '#d97706',    // System yellow
      low: '#4f46e5'        // System blue
    }
    return colors[priority] || '#6b7280'
  }

  const getStatusColor = (status: string): string => {
    const colors: Record<string, string> = {
      pending: '#6b7280',      // System gray
      'in-progress': '#ea580c', // System orange
      completed: '#059669',     // System green
      dismissed: '#6b7280'      // System gray
    }
    return colors[status] || '#6b7280'
  }

  const filteredRecs = filterPriority === 'all' 
    ? recommendations 
    : recommendations.filter(r => r.priority === filterPriority)

  const stats = {
    total: recommendations.length,
    critical: recommendations.filter(r => r.priority === 'critical').length,
    pending: recommendations.filter(r => r.status === 'pending').length,
    avgRiskReduction: Math.round(recommendations.reduce((sum, r) => sum + r.potentialRiskReduction, 0) / recommendations.length)
  }

  return (
    <div className="py-4 w-full max-w-7xl mx-auto">
      <div className="mb-6 px-4 hig-fade-in">
        <h1 className="hig-title-large text-gray-900 dark:text-gray-100 mb-2">Security Recommendations</h1>
        <p className="hig-body text-gray-600 dark:text-gray-400">Prioritized recommendations to improve your security posture</p>
      </div>

      {/* Sticky Status Bar */}
      <div className="sticky top-16 z-40 before:absolute before:inset-0 before:backdrop-blur-xl before:bg-white/80 dark:before:bg-gray-950/80 before:-z-10 border-b border-gray-200 dark:border-gray-700/60 mb-3 -mx-4 sm:-mx-6 lg:-mx-8">
        <div className="px-4 sm:px-6 lg:px-8 py-3">
          <div className="flex items-center justify-between text-sm">
            <div className="flex items-center space-x-6">
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-[#e11d48] rounded-full animate-pulse"></div>
                <span className="hig-caption font-semibold text-gray-900 dark:text-gray-100">
                  {stats.critical} Critical
                </span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-[#ea580c] rounded-full"></div>
                <span className="hig-caption font-semibold text-gray-900 dark:text-gray-100">
                  {stats.pending} Pending
                </span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-[#059669] rounded-full"></div>
                <span className="hig-caption font-semibold text-gray-900 dark:text-gray-100">
                  Avg Risk Reduction: {stats.avgRiskReduction}%
                </span>
              </div>
              <div className="hig-caption">
                {stats.total} total recommendations
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-3 px-4">
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Total Recommendations</div>
          <div className="hig-metric-value text-4xl text-gray-900 dark:text-gray-100">{stats.total}</div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Critical Priority</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#e11d48', WebkitTextFillColor: '#e11d48' }}>
            {stats.critical}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Pending Action</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#ea580c', WebkitTextFillColor: '#ea580c' }}>
            {stats.pending}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Avg Risk Reduction</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#059669', WebkitTextFillColor: '#059669' }}>
            {stats.avgRiskReduction}%
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="mb-6 px-4">
        <div className="flex flex-wrap gap-2">
          {['all', 'critical', 'high', 'medium', 'low'].map(priority => (
            <button
              key={priority}
              onClick={() => setFilterPriority(priority)}
              className={`hig-button ${filterPriority === priority ? 'hig-button-primary' : 'hig-button-secondary'}`}
            >
              {priority === 'all' ? 'All Priorities' : priority.charAt(0).toUpperCase() + priority.slice(1)}
            </button>
          ))}
        </div>
      </div>

      {/* Recommendations List */}
      <div className="px-4">
        <div className="hig-card">
          <div className="flex items-center justify-between mb-3 pb-4 border-b border-gray-200 dark:border-gray-700/60">
            <h2 className="hig-headline text-gray-900 dark:text-gray-100">Recommendations</h2>
            <span className="hig-caption text-gray-600 dark:text-gray-400">{filteredRecs.length} total</span>
          </div>

          <div className="space-y-0">
          {filteredRecs.map((rec, idx) => {
            const priorityColor = getPriorityColor(rec.priority)
            const statusColor = getStatusColor(rec.status)
            
            return (
              <div key={rec.id}>
                <div 
                  className={`flex items-center gap-4 p-4 ${
                    idx !== filteredRecs.length - 1 ? 'border-b border-gray-200 dark:border-gray-700/60' : ''
                  } hover:bg-gray-50 dark:hover:bg-gray-700/20`}
                >
                  {/* Priority Indicator */}
                  <div 
                    className="w-1 h-12 rounded-full flex-shrink-0"
                    style={{ 
                      backgroundColor: priorityColor,
                      boxShadow: `0 0 8px ${priorityColor}40`
                    }}
                  />
                  
                  {/* Recommendation Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="hig-body font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2" title={rec.title}>
                      {rec.title}
                    </h3>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="hig-caption text-gray-600 dark:text-gray-400 font-mono">{rec.id}</span>
                      <span className="hig-caption text-gray-400">•</span>
                      <span className="hig-caption text-gray-600 dark:text-gray-400">
                        {rec.category.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                      </span>
                      <span className="hig-caption text-gray-400">•</span>
                      <span className="hig-caption text-gray-600 dark:text-gray-400">Due: {formatDate(rec.dueDate)}</span>
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${priorityColor}20`,
                          color: priorityColor
                        }}
                      >
                        {rec.priority.toUpperCase()}
                      </span>
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${statusColor}20`,
                          color: statusColor
                        }}
                      >
                        {rec.status.replace('-', ' ').toUpperCase()}
                      </span>
                    </div>
                  </div>
                  
                  {/* Metrics */}
                  <div className="flex items-center gap-3 flex-shrink-0">
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Affected Assets</div>
                      <div className="hig-body text-gray-900 dark:text-gray-100 font-semibold mt-1">
                        {rec.affectedAssets}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Effort</div>
                      <div className="hig-caption text-gray-900 dark:text-gray-100 font-medium mt-1">
                        {rec.estimatedEffort}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Risk Reduction</div>
                      <div className="hig-body font-semibold mt-1" style={{ color: '#059669', WebkitTextFillColor: '#059669' }}>
                        {rec.potentialRiskReduction}%
                      </div>
                    </div>
                    <button 
                      onClick={() => setSelectedRec(rec)}
                      className="hig-caption hig-link-hover"
                    >
                      View Details →
                    </button>
                  </div>
                </div>
              </div>
            )
          })}
          </div>
        </div>
      </div>

      {/* Recommendation Detail Modal */}
      {selectedRec && (
        <div className="hig-modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="hig-modal p-0 max-w-4xl w-full flex flex-col max-h-[90vh]">
            {/* Fixed Header */}
            <div 
              className="sticky top-0 z-10 backdrop-blur-xl backdrop-saturate-150 bg-white/80 dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-700/60 p-6 pb-4"
              style={{
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                backdropFilter: 'blur(20px) saturate(180%)'
              }}
            >
              <div className="flex items-center justify-between mb-2">
                <h2 className="hig-headline text-gray-900 dark:text-gray-100">Recommendation Details</h2>
                <button
                  onClick={() => setSelectedRec(null)}
                  className="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
                >
                  <span className="sr-only">Close</span>
                  <svg className="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                  </svg>
                </button>
              </div>
              {/* Priority Indicator Bar */}
              <div 
                className="h-1 rounded-full" 
                style={{ backgroundColor: getPriorityColor(selectedRec.priority) }}
              />
            </div>

            {/* Scrollable Content */}
            <div className="flex-1 overflow-y-auto px-6 py-6">
              <div className="space-y-4 pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <div>
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Recommendation ID</div>
                  <div className="hig-body font-mono text-gray-900 dark:text-gray-100">{selectedRec.id}</div>
                </div>

                <div>
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Title</div>
                  <div className="hig-headline text-gray-900 dark:text-gray-100">{selectedRec.title}</div>
                </div>

                <div>
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Description</div>
                  <div className="hig-body text-gray-700 dark:text-gray-300 leading-relaxed">
                    This recommendation addresses a critical security concern that requires immediate attention. 
                    Implementing this recommendation will significantly improve your organization's security posture 
                    and reduce the risk of potential security incidents.
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  <div>
                    <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Priority</div>
                    <span 
                      className="hig-badge"
                      style={{
                        backgroundColor: `${getPriorityColor(selectedRec.priority)}20`,
                        color: getPriorityColor(selectedRec.priority)
                      }}
                    >
                      {selectedRec.priority.toUpperCase()}
                    </span>
                  </div>
                  <div>
                    <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Status</div>
                    <span 
                      className="hig-badge"
                      style={{
                        backgroundColor: `${getStatusColor(selectedRec.status)}20`,
                        color: getStatusColor(selectedRec.status)
                      }}
                    >
                      {selectedRec.status.replace('-', ' ').toUpperCase()}
                    </span>
                  </div>
                  <div>
                    <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Category</div>
                    <span 
                      className="hig-badge"
                      style={{
                        backgroundColor: '#4f46e520',
                        color: '#4f46e5'
                      }}
                    >
                      {selectedRec.category.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                    </span>
                  </div>
                </div>
              </div>

              {/* Metric Cards */}
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Affected Assets</div>
                  <div className="hig-metric-value text-3xl text-gray-900 dark:text-gray-100">
                    {selectedRec.affectedAssets}
                  </div>
                </div>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Estimated Effort</div>
                  <div className="hig-body text-gray-900 dark:text-gray-100 font-medium">
                    {selectedRec.estimatedEffort}
                  </div>
                </div>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Risk Reduction</div>
                  <div className="hig-metric-value text-3xl" style={{ color: '#059669', WebkitTextFillColor: '#059669' }}>
                    {selectedRec.potentialRiskReduction}%
                  </div>
                </div>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
                  <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Due Date</div>
                  <div className="hig-body text-gray-900 dark:text-gray-100 font-medium">
                    {formatDate(selectedRec.dueDate)}
                  </div>
                </div>
              </div>

              {/* Implementation Details */}
              <div className="pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <h3 className="hig-headline mb-4">Implementation Details</h3>
                <div className="hig-card bg-[#4f46e5]/10 dark:bg-[#4f46e5]/20 border border-[#4f46e5]/30 p-4">
                  <div className="hig-body text-gray-900 dark:text-gray-100 mb-3">
                    <strong>Recommended Actions:</strong>
                  </div>
                  <ul className="space-y-2">
                    <li className="hig-body text-gray-700 dark:text-gray-300 flex items-start gap-2">
                      <span>•</span>
                      <span>Review and assess the current security configuration</span>
                    </li>
                    <li className="hig-body text-gray-700 dark:text-gray-300 flex items-start gap-2">
                      <span>•</span>
                      <span>Plan the implementation timeline based on estimated effort</span>
                    </li>
                    <li className="hig-body text-gray-700 dark:text-gray-300 flex items-start gap-2">
                      <span>•</span>
                      <span>Coordinate with relevant teams and stakeholders</span>
                    </li>
                    <li className="hig-body text-gray-700 dark:text-gray-300 flex items-start gap-2">
                      <span>•</span>
                      <span>Test the changes in a staging environment before production</span>
                    </li>
                    <li className="hig-body text-gray-700 dark:text-gray-300 flex items-start gap-2">
                      <span>•</span>
                      <span>Monitor and verify the implementation after deployment</span>
                    </li>
                  </ul>
                </div>
              </div>

              {/* Business Impact */}
              <div className="pb-4 border-b border-gray-200 dark:border-gray-700/60 mb-4">
                <h3 className="hig-headline mb-4">Business Impact</h3>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4">
                  <div className="hig-body text-gray-700 dark:text-gray-300">
                    Implementing this recommendation will reduce security risk by <strong>{selectedRec.potentialRiskReduction}%</strong> and 
                    affect <strong>{selectedRec.affectedAssets}</strong> assets. The estimated implementation time is <strong>{selectedRec.estimatedEffort}</strong>, 
                    and the recommendation should be completed by <strong>{formatDate(selectedRec.dueDate)}</strong>.
                  </div>
                </div>
              </div>

              {/* Related Vulnerabilities */}
              <div>
                <h3 className="hig-headline mb-4">Related Information</h3>
                <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Category</div>
                      <div className="hig-body text-gray-900 dark:text-gray-100">
                        {selectedRec.category.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                      </div>
                    </div>
                    <div>
                      <div className="hig-caption text-gray-600 dark:text-gray-400 mb-1">Priority Level</div>
                      <div className="hig-body text-gray-900 dark:text-gray-100">
                        {selectedRec.priority.charAt(0).toUpperCase() + selectedRec.priority.slice(1)}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Fixed Footer */}
            <div 
              className="sticky bottom-0 z-10 backdrop-blur-xl backdrop-saturate-150 bg-white/80 dark:bg-gray-900/80 border-t border-gray-200 dark:border-gray-700/60 p-6 pt-4"
              style={{
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                backdropFilter: 'blur(20px) saturate(180%)'
              }}
            >
              <div className="flex gap-3">
                {selectedRec.status === 'pending' && (
                  <button className="hig-button hig-button-primary flex-1">
                    Start Implementation
                  </button>
                )}
                {selectedRec.status === 'in-progress' && (
                  <button className="hig-button hig-button-primary flex-1">
                    Update Progress
                  </button>
                )}
                <button className="hig-button hig-button-secondary flex-1">
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

