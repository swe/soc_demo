'use client'
import { formatDate, formatDateTime } from '@/lib/utils'
import { useEffect, useState } from 'react'
import { usePageTitle } from '@/app/page-title-context'

interface Remediation {
  id: string
  vulnerability: string
  cve: string
  action: string
  priority: 'critical' | 'high' | 'medium' | 'low'
  status: 'scheduled' | 'in-progress' | 'completed' | 'failed' | 'rollback'
  assignedTo: string
  scheduledDate: string
  completedDate?: string
  affectedSystems: number
  successRate: number
}

export default function RemediationsPage() {
  const { setPageTitle } = usePageTitle()
  const [filterStatus, setFilterStatus] = useState<string>('all')

  useEffect(() => {
    setPageTitle('Remediations')
  }, [setPageTitle])

  const remediations: Remediation[] = [
    {
      id: 'REM-001',
      vulnerability: 'Apache Struts RCE',
      cve: 'CVE-2024-1234',
      action: 'Apply security patch 2.5.31',
      priority: 'critical',
      status: 'in-progress',
      assignedTo: 'DevOps Team',
      scheduledDate: '2024-03-30',
      affectedSystems: 23,
      successRate: 65
    },
    {
      id: 'REM-002',
      vulnerability: 'SQL Injection',
      cve: 'CVE-2024-5678',
      action: 'Update application to v3.2.1',
      priority: 'high',
      status: 'scheduled',
      assignedTo: 'Development Team',
      scheduledDate: '2024-04-02',
      affectedSystems: 12,
      successRate: 0
    },
    {
      id: 'REM-003',
      vulnerability: 'Authentication Bypass',
      cve: 'CVE-2024-9012',
      action: 'Deploy hotfix and restart services',
      priority: 'critical',
      status: 'completed',
      assignedTo: 'Security Team',
      scheduledDate: '2024-03-25',
      completedDate: '2024-03-26',
      affectedSystems: 45,
      successRate: 100
    },
    {
      id: 'REM-004',
      vulnerability: 'XSS Vulnerability',
      cve: 'CVE-2024-3456',
      action: 'Implement input validation',
      priority: 'medium',
      status: 'completed',
      assignedTo: 'Development Team',
      scheduledDate: '2024-03-20',
      completedDate: '2024-03-23',
      affectedSystems: 8,
      successRate: 100
    },
    {
      id: 'REM-005',
      vulnerability: 'Privilege Escalation',
      cve: 'CVE-2024-7890',
      action: 'Kernel update to 5.15.0-97',
      priority: 'high',
      status: 'failed',
      assignedTo: 'System Admins',
      scheduledDate: '2024-03-28',
      affectedSystems: 67,
      successRate: 25
    }
  ]

  const getPriorityColor = (priority: string): string => {
    const colors: Record<string, string> = {
      critical: '#e11d48',  // System red
      high: '#ea580c',      // System orange
      medium: '#d97706',   // System yellow
      low: '#4f46e5'        // System blue
    }
    return colors[priority] || '#6b7280'
  }

  const getStatusColor = (status: string): string => {
    const colors: Record<string, string> = {
      scheduled: '#4f46e5',     // System blue
      'in-progress': '#ea580c', // System orange
      completed: '#059669',     // System green
      failed: '#e11d48',        // System red
      rollback: '#ea580c'       // System orange
    }
    return colors[status] || '#6b7280'
  }

  const filteredRems = filterStatus === 'all' 
    ? remediations 
    : remediations.filter(r => r.status === filterStatus)

  const stats = {
    total: remediations.length,
    completed: remediations.filter(r => r.status === 'completed').length,
    inProgress: remediations.filter(r => r.status === 'in-progress').length,
    failed: remediations.filter(r => r.status === 'failed').length
  }

  return (
    <div className="py-4 w-full max-w-7xl mx-auto">
      {/* Page header */}
      <div className="mb-6 px-4 hig-fade-in">
        <h1 className="hig-title-large text-gray-900 dark:text-gray-100 mb-2">Vulnerability Remediation</h1>
        <p className="hig-body text-gray-600 dark:text-gray-400">Track and manage vulnerability remediation activities</p>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-3 px-4">
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Total Remediations</div>
          <div className="hig-metric-value text-4xl text-gray-900 dark:text-gray-100">{stats.total}</div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Completed</div>
          <div className="hig-metric-value text-4xl text-gray-900 dark:text-gray-100" style={{ color: '#059669', WebkitTextFillColor: '#059669' }}>
            {stats.completed}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">In Progress</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#ea580c', WebkitTextFillColor: '#ea580c' }}>
            {stats.inProgress}
          </div>
        </div>
        <div className="hig-card bg-gray-50 dark:bg-gray-700/30 p-4 text-center">
          <div className="hig-caption text-gray-600 dark:text-gray-400 mb-2">Failed</div>
          <div className="hig-metric-value text-4xl" style={{ color: '#e11d48', WebkitTextFillColor: '#e11d48' }}>
            {stats.failed}
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="mb-6 px-4">
        <div className="flex flex-wrap gap-2">
          {['all', 'scheduled', 'in-progress', 'completed', 'failed'].map(status => (
            <button
              key={status}
              onClick={() => setFilterStatus(status)}
              className={`hig-button ${filterStatus === status ? 'hig-button-primary' : 'hig-button-secondary'}`}
            >
              {status === 'all' ? 'All Status' : status.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
            </button>
          ))}
        </div>
      </div>

      {/* Remediations List with Expandable Details */}
      <div className="px-4">
        <div className="hig-card">
          <div className="flex items-center justify-between mb-3 pb-4 border-b border-gray-200 dark:border-gray-700/60">
            <h2 className="hig-headline text-gray-900 dark:text-gray-100">Remediations</h2>
            <span className="hig-caption text-gray-600 dark:text-gray-400">{filteredRems.length} total</span>
          </div>

          <div className="space-y-0">
          {filteredRems.map((rem, idx) => {
            const priorityColor = getPriorityColor(rem.priority)
            const statusColor = getStatusColor(rem.status)
            
            return (
              <div key={rem.id}>
                <div 
                  className={`flex items-center gap-4 p-4 ${
                    idx !== filteredRems.length - 1 ? 'border-b border-gray-200 dark:border-gray-700/60' : ''
                  } hover:bg-gray-50 dark:hover:bg-gray-700/20`}
                >
                  {/* Priority Indicator */}
                  <div 
                    className="w-1 h-12 rounded-full flex-shrink-0"
                    style={{ 
                      backgroundColor: priorityColor,
                      boxShadow: `0 0 8px ${priorityColor}40`
                    }}
                  />
                  
                  {/* ID */}
                  <div className="w-24 flex-shrink-0">
                    <span className="hig-caption font-mono text-gray-600 dark:text-gray-400">
                      {rem.id}
                    </span>
                  </div>
                  
                  {/* Vulnerability Info */}
                  <div className="flex-1 min-w-0">
                    <h3 className="hig-body font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2" title={rem.vulnerability}>
                      {rem.vulnerability}
                    </h3>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="hig-caption text-gray-600 dark:text-gray-400 font-mono">{rem.cve}</span>
                      <span className="hig-caption text-gray-400">â€¢</span>
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${priorityColor}20`,
                          color: priorityColor
                        }}
                      >
                        {rem.priority.toUpperCase()}
                      </span>
                      <span 
                        className="hig-badge"
                        style={{
                          backgroundColor: `${statusColor}20`,
                          color: statusColor
                        }}
                      >
                        {rem.status.replace('-', ' ').toUpperCase()}
                      </span>
                    </div>
                  </div>
                  
                  {/* Metrics */}
                  <div className="flex items-center gap-3 flex-shrink-0">
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Progress</div>
                      <div className="flex items-center gap-2 mt-1">
                        <div className="w-20 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                          <div 
                            className="h-2 rounded-full" 
                            style={{ 
                              width: `${rem.successRate}%`,
                              backgroundColor: rem.status === 'completed' ? '#059669' : rem.status === 'failed' ? '#e11d48' : '#ea580c'
                            }}
                          ></div>
                        </div>
                        <span className="hig-caption text-gray-600 dark:text-gray-400">{rem.successRate}%</span>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Assigned To</div>
                      <div className="hig-caption text-gray-900 dark:text-gray-100 font-medium mt-1">
                        {rem.assignedTo}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="hig-caption text-gray-600 dark:text-gray-400">Scheduled</div>
                      <div className="hig-caption text-gray-900 dark:text-gray-100 font-medium mt-1">
                        {formatDate(rem.scheduledDate)}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )
          })}
          </div>
        </div>
      </div>
    </div>
  )
}
